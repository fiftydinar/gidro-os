#!/usr/bin/env bash

# Reduce dirty bytes for USB devices, to make it write more directly to storage, instead to cache

block_device="${1}"
current_usb_speed="${2}"

# apply strict limit to dirty bytes & 50% of the RAM as an USB cache maximum
strict_limit=1
max_ratio=50
echo "${strict_limit}" > "/sys/block/${block_device}/bdi/strict_limit"
echo "${max_ratio}" > "/sys/block/${block_device}/bdi/max_ratio"
    
max_bytes_calculation=$(echo "scale=0; ((${current_usb_speed} / 8) * 0.05 * 1.3) * 1024 * 1024" | bc)
max_bytes=$(printf "%d\n" "${max_bytes_calculation}")

# apply bandwidth defined value
echo "${max_bytes}" > "/sys/block/${block_device}/bdi/max_bytes"
