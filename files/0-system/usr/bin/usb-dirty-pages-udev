#!/usr/bin/env bash

# Reduce dirty bytes for USB devices, to make it write more directly to storage, instead to cache

strict_limit=1

# block device is passed in ${1}
# vendor id is passed as ${2}
# model id is passed as ${3}

# Determine current USB device speed, as ATTRS{speed} is unreliable - it detects xHCI USB speed instead of proper USB speed
current_usb_speed=$(lsusb -t -v | awk -v vendor_id="${2}" -v module_id="${3}" '$0 ~ vendor_id ":" module_id {split(prev, a, " "); print a[length(a)]} {prev=$0}' | grep -o '[0-9]*')

# speed defined values
max_bytes_12=10486
max_bytes_480=629146
max_bytes_5000=6553600
max_bytes_10000=13107200
max_bytes_custom="max_bytes_${current_usb_speed}"

echo "${strict_limit}" > "/sys/block/${1}/bdi/strict_limit"
# apply bandwidth defined value
echo "${!max_bytes_custom}" > "/sys/block/${1}/bdi/max_bytes"
