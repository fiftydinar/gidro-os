#!/usr/bin/env bash

# GLOBAL
INITRAMFS=$(rpm-ostree initramfs-etc)
NEEDED_INITRAMFS=("/etc/crypttab")
NEEDS_INITRAMFS_APPLICATION=false
MINIMUM_FREE_ZRAM=$(awk '/MemTotal/ {printf "%.0f", $2 * 0.01}' /proc/meminfo)
CURRENT_FREE_ZRAM=$(sysctl vm.min_free_kbytes | awk '{print $3}')

# INITRAMFS
echo "Current initramfs: $INITRAMFS"

NEEDED_INITRAMFS+=("/etc/modprobe.d/modprobe-gidro.conf")

for INITRAMFS_ARG in ${NEEDED_INITRAMFS[@]}; do
  if [[ ! $INITRAMFS =~ "$INITRAMFS_ARG" ]]; then
    NEEDS_INITRAMFS_APPLICATION=true
  fi
done

if $NEEDS_INITRAMFS_APPLICATION; then
  echo "Found needed initramfs changes, applying the following: ${NEEDED_INITRAMFS[*]}"
  plymouth display-message --text="Updating initramfs - System will reboot" || true
  rpm-ostree initramfs-etc "${NEEDED_INITRAMFS[@]/#/--track=}" --reboot         
else
  echo "No initramfs changes needed"
fi

# Minimum-free ZRAM
echo "Current minimum-free ZRAM value: $CURRENT_FREE_ZRAM"

if ((MINIMUM_FREE_ZRAM > CURRENT_FREE_ZRAM)); then
    sysctl -w "vm.min_free_kbytes=${MINIMUM_FREE_ZRAM}"
    echo "Found needed minimum-free ZRAM changes, applying the following: ${MINIMUM_FREE_ZRAM}"
else
  echo "No minimum-free ZRAM changes needed"
fi
