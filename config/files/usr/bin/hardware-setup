#!/usr/bin/env bash

# GLOBAL
INITRAMFS=$(rpm-ostree initramfs)
NEEDED_INITRAMFS=("/etc/crypttab")
NEEDS_INITRAMFS_APPLICATION=false

# INITRAMFS
echo "Current initramfs: $INITRAMFS"

NEEDED_INITRAMFS+=("/etc/modprobe.d/amdgpu-gidro.conf")
NEEDED_INITRAMFS+=("/etc/modprobe.d/blacklist-gidro.conf")

for INITRAMFS_ARG in ${NEEDED_INITRAMFS[@]}; do
  if [[ ! $INITRAMFS =~ "$INITRAMFS_ARG" ]]; then
    NEEDS_INITRAMFS_APPLICATION=true
  fi
done

if $NEEDS_INITRAMFS_APPLICATION; then
  echo "Found needed initramfs changes, applying the following: ${NEEDED_INITRAMFS[*]}"
  plymouth display-message --text="Updating initramfs - System will reboot" || true
  rpm-ostree initramfs --enable --arg="-I ${NEEDED_INITRAMFS[*]}" --reboot
else
  echo "No initramfs changes needed"
fi
