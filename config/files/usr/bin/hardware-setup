#!/usr/bin/env bash

# GLOBAL
INITRAMFS=$(rpm-ostree initramfs-etc)
NEEDED_INITRAMFS=("--track /etc/crypttab")
NEEDS_INITRAMFS_APPLICATION=false
KARGS=$(rpm-ostree kargs)
NEEDED_KARGS=()
CPU_ID=(lscpu | grep 'Model name' | cut -f 2 -d ":" | awk '{$1=$1}1')
CPU_FAMILY=(lscpu | grep 'CPU family' | cut -f 2 -d ":" | awk '{$1=$1}1')

# INITRAMFS & KARGS
echo "Current initramfs: $INITRAMFS"

NEEDED_INITRAMFS+=("--track /etc/modprobe.d/amdgpu.conf")
NEEDED_INITRAMFS+=("--track /etc/modprobe.d/blacklist.conf")

if [[ ":AMD:" =~ ":$CPU_ID:" ]] && [[ ":23:" =~ ":$CPU_FAMILY:" ]] || [[ ":25:" =~ ":$CPU_FAMILY:" ]]; then
  echo "Applying Zen 2+ amd-pstate active workaround"
  if [[ ! $KARGS =~ "amd_pstate" ]]; then
    NEEDED_KARGS+=("--append-if-missing=amd_pstate=active")
  fi
fi

if [[ $KARGS =~ "nomodeset" ]]; then
  echo "Removing nomodeset"
  NEEDED_KARGS+=("--delete-if-present=nomodeset")
fi

for INITRAMFS_ARG in ${NEEDED_INITRAMFS[@]}; do
  if [[ ! $INITRAMFS =~ "$INITRAMFS_ARG" ]]; then
    NEEDS_INITRAMFS_APPLICATION=true
  fi
done

if [[ $INITRAMFS =~ "No tracked files." ]]; then
  echo "Immediate system reboot is needed for initramfs changes to apply"
else
  if $NEEDS_INITRAMFS_APPLICATION; then
    echo "Found needed initramfs changes, applying the following: ${NEEDED_INITRAMFS[*]}"
    plymouth display-message --text="Updating initramfs - Please wait, this may take a while" || true
    rpm-ostree initramfs-etc "${NEEDED_INITRAMFS[*]}"
  else
    echo "No initramfs changes needed"
  fi
fi

if [[ -n "$NEEDED_KARGS" ]]; then
  echo "Found needed karg changes, applying the following: ${NEEDED_KARGS[*]}"
  plymouth display-message --text="Updating kargs - Please wait, this may take a while" || true
  rpm-ostree kargs ${NEEDED_KARGS[*]} || exit 1
else
  echo "No karg changes needed"
fi

if [[ $INITRAMFS =~ "No tracked files." ]]; then
  echo "Found needed initramfs reboot changes, applying the following: ${NEEDED_INITRAMFS[*]}"
  plymouth display-message --text="Updating initramfs - System will reboot" || true
  rpm-ostree initramfs-etc "${NEEDED_INITRAMFS[*]}" --force-sync --reboot
else
  echo "Immediate system reboot is not needed for initramfs changes"
fi
