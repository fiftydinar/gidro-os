#!/usr/bin/env bash

# GLOBAL
GPU_ID=$(lspci -k | grep -A 3 -E "(VGA|3D)")
KARGS=$(rpm-ostree kargs)
NEEDED_KARGS=""
echo "Current kargs: $KARGS"

# KERNEL ARGUMENTS
if [[ ! $KARGS =~ "nowatchdog" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=nowatchdog"
fi

if [[ ! $KARGS =~ "nmi_watchdog" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=nmi_watchdog=0"
fi

if [[ ! $KARGS =~ "modprobe.blacklist=sp5100_tco" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=modprobe.blacklist=sp5100_tco"
fi

if [[ ! $KARGS =~ "modprobe.blacklist=iTCO_wdt" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=modprobe.blacklist=iTCO_wdt"
fi

if grep -qz "Kernel driver in use: radeon" <<< $GPU_ID; then
  echo "Legacy AMD hardware detected, enabling CIK and SI support in AMDGPU"
  if [[ ! $KARGS =~ "radeon.si_support" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=radeon.si_support=0"
  fi

  if [[ ! $KARGS =~ "radeon.cik_support" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=radeon.cik_support=0"
  fi

  if [[ ! $KARGS =~ "amdgpu.si_support" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=amdgpu.si_support=1"
  fi

  if [[ ! $KARGS =~ "amdgpu.cik_support" ]]; then
    NEEDED_KARGS="$NEEDED_KARGS --append=amdgpu.cik_support=1"
  fi
fi

if [[ $KARGS =~ "nomodeset" ]]; then
  echo "Removing nomodeset"
  NEEDED_KARGS="$NEEDED_KARGS --delete-if-present=nomodeset"
fi

if [[ ! $KARGS =~ "rd.luks.options" ]]; then
  NEEDED_KARGS="$NEEDED_KARGS --append=rd.luks.options=discard"
fi

if [[ -n "$NEEDED_KARGS" ]]; then
  echo "Found needed karg changes, applying the following: $NEEDED_KARGS"
  rpm-ostree kargs ${NEEDED_KARGS} --reboot || exit 1
else
  echo "No karg changes needed"
fi
