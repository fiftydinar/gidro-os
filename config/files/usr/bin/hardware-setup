#!/usr/bin/env bash

# GLOBAL
initramfs=$(rpm-ostree initramfs-etc | grep -v "Tracked files:" | tr -d ' ')
needed_initramfs=("/etc/crypttab")
needs_initramfs_tracking=false
needs_initramfs_untracking=false
minimum_free_zram=$(awk '/MemTotal/ {printf "%.0f", $2 * 0.01}' /proc/meminfo)
current_free_zram=$(sysctl vm.min_free_kbytes | awk '{print $3}')

# INITRAMFS
printf "Current initramfs: %s\n" "$initramfs"

needed_initramfs+=("/etc/modprobe.d/modprobe-gidro.conf" "/etc/vconsole.conf")

for initramfs_arg in "${needed_initramfs[@]}"; do
  if [[ ! $initramfs =~ $initramfs_arg ]]; then
    needs_initramfs_tracking=true
  fi
done

for initramfs_arg in "${initramfs[@]}"; do
  if [[ ! $needed_initramfs =~ $initramfs_arg ]]; then
    needs_initramfs_untracking=true
    untracked_initramfs+=("$initramfs_arg")
  fi
done

tracked_args=("${needed_initramfs[@]/#/--track=}")
untracked_args=("${untracked_initramfs[@]/#/--untrack=}")

if $needs_initramfs_tracking || $needs_initramfs_untracking; then
  if $needs_initramfs_tracking && $needs_initramfs_untracking; then
    printf "Found needed tracking initramfs changes, applying the following: %s\n" "${needed_initramfs[*]}"
    printf "Also applying needed removal of non-active tracked files: %s\n" "${untracked_initramfs[*]}"
    plymouth display-message --text="Updating initramfs - System will reboot" || true
    rpm-ostree initramfs-etc "${untracked_args[@]}" "${tracked_args[@]}" --reboot
    if [[ $needs_initramfs_tracking == false && $needs_initramfs_untracking ]]; then
      printf "Found needed removal of non-active tracked files, applying the following: %s\n" "${untracked_initramfs[*]}"
      plymouth display-message --text="Updating initramfs - System will reboot" || true
      rpm-ostree initramfs-etc "${untracked_args[@]}" --reboot
      if [[ $needs_initramfs_tracking && $needs_initramfs_untracking == false ]]; then
        printf "Found needed tracking initramfs changes, applying the following: %s\n" "${needed_initramfs[*]}"
        plymouth display-message --text="Updating initramfs - System will reboot" || true
        rpm-ostree initramfs-etc "${tracked_args[@]}" --reboot
      fi
    fi
  fi    
else
  echo "No initramfs changes needed"
fi

# Minimum-free ZRAM
printf "Current minimum-free ZRAM value: %s\n" "$current_free_zram"

if ((minimum_free_zram > current_free_zram)); then
    sysctl -w "vm.min_free_kbytes=${minimum_free_zram}"
    printf "Found needed minimum-free ZRAM changes, applying the following: %s\n" "$minimum_free_zram"
else
  echo "No minimum-free ZRAM changes needed"
fi

